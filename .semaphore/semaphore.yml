version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: ''
    os_image: ''
blocks:
  - name: Elixir tests
    task:
      jobs:
        - name: 'Job #1'
          commands:
            - checkout
            - cd elixir
            - mix local.hex --force
            - mix local.rebar --force
            - cache restore
            - 'mix do deps.get, compile --warnings-as-errors'
            - cache store
            - mix test
      prologue:
        commands:
          - sem-version elixir 1.11
      epilogue:
        always:
          commands:
            - test-results publish /tmp/junit.xml
after_pipeline:
  task:
    jobs:
      - name: Submit Reports
        commands:
          - test-results gen-pipeline-report
promotions:
  - name: Run tests with prefix
    pipeline_file: prefixed_tests.yml
    parameters:
      env_vars:
        - required: true
          default_value: prefix
          description: Test prefix
          name: TEST_PREFIX
        - required: true
          options:
            - "true"
            - "false"
          default_value: "false"
          description: Randomize failures
          name: RANDOMIZE_FAILURES
